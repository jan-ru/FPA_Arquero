# Data Transformation Proposal

## Current Data Structure Analysis

### Problem: Wide Format (Periods as Columns)

The current Excel files have a **wide format** where:
- Each month is a separate column (januari2024, februari2024, etc.)
- Each row represents one account
- This creates 431 rows × 33 columns for 2024 data

**Current Structure (2024 file):**
```
CodeGrootboekrekening | NaamGrootboekrekening | Openingsbalans2024 | januari2024 | februari2024 | ... | december2024 | Saldo
0080                  | Ontwikkelingskosten   | 3180101            | 20207       | 31858        | ... | 89           | 3559581
0081                  | Cum. afschr. ontw.    | -2424872           | -14461      | -13810       | ... | -13929       | -2618112
```

### Required Structure: Long Format (Tabular)

The application expects a **long format** where:
- Each row represents one account for one period
- Columns: `account_code`, `account_description`, `amount`
- The `period` field is added programmatically

**Required Structure:**
```
account_code | account_description              | amount
0080         | Ontwikkelingskosten              | 3559581
0081         | Cum. afschr. ontwikkelingskosten | -2618112
0210         | Machines en Installaties         | 50883
...
```

## Proposed Solutions

### Option 1: Pre-process Excel Files (Recommended)

Create a Deno script to transform the wide format to long format before loading into the application.

**Advantages:**
- Clean separation of concerns
- Reusable transformation script
- Can be run as needed when source data changes
- Easier to debug and validate

**Implementation:**
```typescript
// transform_data.ts
// Reads wide format Excel → Outputs long format Excel
// Input: 2024_BalansenWinstverliesperperiode.xlsx
// Output: trial_balance_2024.xlsx
```

### Option 2: Modify DataLoader in Application

Update the `DataLoader.loadTrialBalance()` method to handle wide format and transform on-the-fly.

**Advantages:**
- No pre-processing step needed
- Works directly with source files

**Disadvantages:**
- More complex application code
- Harder to debug
- Performance impact (transformation happens every load)

### Option 3: Hybrid Approach

Create both:
1. A standalone transformation script (for batch processing)
2. An optional "wide format" mode in DataLoader (for flexibility)

## Recommended Approach: Option 1

### Transformation Script Specification

**Input Files:**
- `input/2024_BalansenWinstverliesperperiode.xlsx`
- `input/2025_BalansenWinstverliesperperiode.xlsx`

**Output Files:**
- `input/trial_balance_2024.xlsx`
- `input/trial_balance_2025.xlsx`

**Transformation Logic:**

1. **Read source file**
   - Sheet: "BalansenWinstverliesperperiode"
   - Key columns:
     - Col 11: `CodeGrootboekrekening` → `account_code`
     - Col 12: `NaamGrootboekrekening` → `account_description`
     - Col 33: `Saldo` → `amount` (year-end balance)

2. **Extract account information**
   - Use `CodeGrootboekrekening` as account_code
   - Use `NaamGrootboekrekening` as account_description
   - Use `Saldo` (final column) as the amount for the year

3. **Filter rows**
   - Skip rows where `CodeGrootboekrekening` is empty
   - Skip rows where `Saldo` is empty or null

4. **Create output**
   - Three columns: account_code, account_description, amount
   - One row per account
   - Header row: ["account_code", "account_description", "amount"]

### Hierarchy Mapping

The `DimAccounts.xlsx` file needs to be transformed to match the hierarchy format:

**Current Structure:**
```
Statement | Nivo0   | Nivo1          | Nivo2                    | Rekening | Nivo4
Balans    | Activa  | Vaste activa   | Immateriële vaste activa | 80       | 80 - Ontwikkelingskosten
```

**Required Structure:**
```
account_code | statement_type | category     | subcategory              | line_order
80           | BS             | Assets       | Immateriële vaste activa | 110
81           | BS             | Assets       | Immateriële vaste activa | 110
```

**Mapping Rules:**
- `Rekening` → `account_code`
- `Statement` → `statement_type` (Balans→BS, Omzet/Kosten→IS)
- `Nivo0` → `category` (Activa→Assets, Passiva→Liabilities, Omzet→Revenue, Kosten→Expenses)
- `Nivo2` → `subcategory`
- `Sort2` → `line_order`

### Dates Table

The `DimDates.xlsx` is overly complex. We only need:

**Required Structure:**
```
period | year | period_start | period_end
2024   | 2024 | 2024-01-01   | 2024-12-31
2025   | 2025 | 2025-01-01   | 2025-12-31
```

This can be created manually or generated by the transformation script.

## Implementation Plan

### Step 1: Create Transformation Script

```bash
# Create transform_data.ts
deno run --allow-read --allow-write transform_data.ts
```

**Script will:**
1. Read 2024_BalansenWinstverliesperperiode.xlsx
2. Extract account_code, account_description, Saldo
3. Write to trial_balance_2024.xlsx
4. Repeat for 2025 file
5. Use DimAccounts.xlsx as-is (no transformation needed)
6. Use DimDates.xlsx as-is (no transformation needed)

### Step 2: Update Configuration

Update `config.json` to point to transformed files (already correct):
```json
{
  "inputFiles": {
    "trialBalance2024": "trial_balance_2024.xlsx",
    "trialBalance2025": "trial_balance_2025.xlsx",
    "hierarchy": "hierarchy.xlsx",
    "dates": "dates.xlsx",
    "format": "format.xlsx"
  }
}
```

### Step 3: Create Format Table

The format table needs to be created based on the desired statement layout. This can be derived from the hierarchy structure.

## Alternative: Use Year-End Balance Only

**Simplification:** Instead of transforming monthly data, use only the `Saldo` (year-end balance) column.

**Rationale:**
- Financial statements typically show year-end positions
- Simplifies transformation significantly
- Monthly data can be added later if needed

**Trade-off:**
- Loses monthly granularity
- Cannot do month-over-month analysis
- But meets the core requirement: compare 2024 vs 2025 year-end

## Next Steps

1. **Confirm approach**: Do you want to use year-end balances only, or transform monthly data?
2. **Create transformation script**: Implement the Deno script
3. **Test transformation**: Verify output matches expected format
4. **Update application**: Ensure DataLoader works with transformed data
5. **Document process**: Add transformation instructions to README

## Questions for Clarification

1. **Period granularity**: Do you need monthly data, or is year-end sufficient?
2. **Statement types**: The data includes "BAS" (Balans) and likely "WV" (Winst en Verlies). Should we map these to BS and IS?
3. **Cash Flow**: Is there cash flow data in the source files, or should we skip CF statement for now?
4. **Format table**: Should we auto-generate this from the hierarchy, or create it manually?

## Recommended Immediate Action

Create a simple transformation script that:
1. Extracts year-end balances (Saldo column) from both files
2. Creates trial_balance_2024.xlsx and trial_balance_2025.xlsx
3. Uses DimAccounts.xlsx as-is (application handles the format)
4. Uses DimDates.xlsx as-is (application handles the format)

This gets the application working quickly, and we can enhance it later with monthly data if needed.
